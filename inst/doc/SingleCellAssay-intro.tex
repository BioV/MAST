\documentclass{article}\usepackage{graphicx, color}
%% maxwidth is the original width if it is less than linewidth
%% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\definecolor{fgcolor}{rgb}{0.2, 0.2, 0.2}
\newcommand{\hlnumber}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlfunctioncall}[1]{\textcolor[rgb]{0.501960784313725,0,0.329411764705882}{\textbf{#1}}}%
\newcommand{\hlstring}[1]{\textcolor[rgb]{0.6,0.6,1}{#1}}%
\newcommand{\hlkeyword}[1]{\textcolor[rgb]{0,0,0}{\textbf{#1}}}%
\newcommand{\hlargument}[1]{\textcolor[rgb]{0.690196078431373,0.250980392156863,0.0196078431372549}{#1}}%
\newcommand{\hlcomment}[1]{\textcolor[rgb]{0.180392156862745,0.6,0.341176470588235}{#1}}%
\newcommand{\hlroxygencomment}[1]{\textcolor[rgb]{0.43921568627451,0.47843137254902,0.701960784313725}{#1}}%
\newcommand{\hlformalargs}[1]{\textcolor[rgb]{0.690196078431373,0.250980392156863,0.0196078431372549}{#1}}%
\newcommand{\hleqformalargs}[1]{\textcolor[rgb]{0.690196078431373,0.250980392156863,0.0196078431372549}{#1}}%
\newcommand{\hlassignement}[1]{\textcolor[rgb]{0,0,0}{\textbf{#1}}}%
\newcommand{\hlpackage}[1]{\textcolor[rgb]{0.588235294117647,0.709803921568627,0.145098039215686}{#1}}%
\newcommand{\hlslot}[1]{\textit{#1}}%
\newcommand{\hlsymbol}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlprompt}[1]{\textcolor[rgb]{0.2,0.2,0.2}{#1}}%

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
\usepackage{url, graphicx}
\usepackage{color}
\usepackage[cm]{fullpage}
\usepackage[usenames,dvipsnames]{xcolor}
%\usepackage[authoryear]{natbib}

%\makeatletter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% User specified LaTeX commands.
% \VignetteIndexEntry{An Introduction to SingleCellAssay}

%\makeatother
\newcommand{\future}[1]{TODO: {\color{gray} #1}}
\newcommand{\sca}{\texttt{SingleCellAssay}}
\input{symbols.tex}
\begin{document}
\title{An Introduction to SingleCellAssay}


\author{Andrew McDavid}

\maketitle
\section{Philosophy}
 \sca is an R/Bioconductor package for Fluidigm and friends. 
We seek to support assays that have multiple \emph{features} (genes, markers, etc) per \emph{well} (cell, etc) in a flexible format.
The assays is mostly \emph{complete} in the sense that most wells contain measurements for all features.
We test for completeness, and complete the object if it is not, so very incomplete assays just make things a bit slower. 

Internally, we store everything as one giant \texttt{data.frame} with names of special columns kept in a \texttt{mapping} that contains column names and keywords.  
It is in long-melted format, in feature-major order, so not especially fast or space-efficient, but rather is intended to be very flexible.

Each well, feature \future{, and unit (phenotype)} has covariates measured.
These are kept in \texttt{AnnotatedDataframes}, which are generated from the basal \texttt{data.frame}, if so provided.
\future{If not provided, then they can be added after object creation.}

\section{Reading Data}
Data imported in a Fluidigm instrument-specific format (whose details are undocumented, and probably subject-to-change) or in ``long'' (melted) format, in which each row is a measurement, so if there are $N$ wells and $M$ cells, then the \texttt{data.frame} should contain $N \times M$ rows.

For example, the following data set was provided in as a comma-separated value file.
It has the cycle threshold ($\ct$) recorded, with non-detected genes recorded as NAs.
For the Fluidigm/qPCR single cell expression functions to work as expected, we must report the expression threshold ($c_{\mbox{max}} - \ct$), which is proportional to the log-expression.
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlfunctioncall{data}(vbeta)
\end{alltt}
\begin{flushleft}\ttfamily\noindent\textcolor{warningcolor}{\#\# Warning: data set 'vbeta' not found}\end{flushleft}\begin{alltt}
vbeta <- \hlfunctioncall{within.data.frame}(vbeta, \{
    Et <- 40 - Ct
    Et <- \hlfunctioncall{ifelse}(\hlfunctioncall{is.na}(Et), 0, Et)
\})
vbeta.fa <- \hlfunctioncall{FluidigmAssay}(vbeta, idvars = \hlfunctioncall{c}(\hlstring{"Subject.ID"}, \hlstring{"Chip.Number"}, \hlstring{"Well"}), 
    primerid = \hlstring{"Gene"}, measurement = \hlstring{"Et"}, ncells = \hlstring{"Number.of.Cells"}, geneid = \hlstring{"Gene"}, 
    cellvars = \hlfunctioncall{c}(\hlstring{"Number.of.Cells"}, \hlstring{"Population"}), phenovars = \hlfunctioncall{c}(\hlstring{"Stim.Condition"}, 
        \hlstring{"Time"}), id = \hlstring{"vbeta all"})
\hlfunctioncall{show}(vbeta.fa)
\end{alltt}
\begin{verbatim}
## FluidigmAssay  id:  vbeta all 
##  456  wells;  75  features
\end{verbatim}
\end{kframe}
\end{knitrout}


We specify \texttt{vbeta}, as the \texttt{data.frame} from which the \texttt{FluidigmAssay} object will be created, the \texttt{idvars} which is a column(s) in \texttt{vbeta} that unique identify a well, the \texttt{primerid}, which is a column(s) that specify which feature is measured at this nrow.
The \texttt{measurement} gives the column name containing the log-expression measurement, \texttt{ncells} contains the number of cells (or other normalizing factor) for the well.  \texttt{geneid}, \texttt{cellvars}, \texttt{phenovars} all specify additional columns to be included in the \texttt{featureData}, \texttt{phenoData}  and \texttt{cellData} (\future{wellData}):
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlfunctioncall{head}(\hlfunctioncall{fData}(vbeta.fa))
\end{alltt}
\begin{verbatim}
##          Gene
## B3GAT1 B3GAT1
## BAX       BAX
## BCL2     BCL2
## CCL2     CCL2
## CCL3     CCL3
## CCL4     CCL4
\end{verbatim}
\begin{alltt}
\hlfunctioncall{head}(\hlfunctioncall{cData}(vbeta.fa))
\end{alltt}
\begin{verbatim}
##   Number.of.Cells            Population Subject.ID Chip.Number Well
## 1               1 CD154+VbetaResponsive      Sub01           1  A01
## 2               1 CD154+VbetaResponsive      Sub01           1  A02
## 3               1 CD154+VbetaResponsive      Sub01           1  A03
## 4               1 CD154+VbetaResponsive      Sub01           1  A04
## 5               1 CD154+VbetaResponsive      Sub01           1  A05
## 6               1 CD154+VbetaResponsive      Sub01           1  A06
##   Stim.Condition Time
## 1      Stim(SEB)   12
## 2      Stim(SEB)   12
## 3      Stim(SEB)   12
## 4      Stim(SEB)   12
## 5      Stim(SEB)   12
## 6      Stim(SEB)   12
\end{verbatim}
\end{kframe}
\end{knitrout}


\section{Subsetting, splitting, combining}
It's possible to subset \sca objects by wells \future{ and features}.
Double square brackets (``[['') and \texttt{subset} subset by wells. 
Both integer and boolean indices may be used.
The usual recycling rules (if the index is shorter than the number of rows) apply.
\future{Single square brackets subset by [wells, features].}
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
sub1 <- vbeta.fa[[1:10]]
\hlfunctioncall{show}(sub1)
\end{alltt}
\begin{verbatim}
## SingleCellAssay  id:  vbeta all 
##  10  wells;  75  features
\end{verbatim}
\begin{alltt}
sub2 <- \hlfunctioncall{subset}(vbeta.fa, Well == \hlstring{"A01"})
\hlfunctioncall{show}(sub2)
\end{alltt}
\begin{verbatim}
## SingleCellAssay  id:  vbeta all 
##  5  wells;  75  features
\end{verbatim}
\end{kframe}
\end{knitrout}


A \sca may be split into a list of \sca, which is known as a \texttt{SCASet}.
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
sp1 <- \hlfunctioncall{split}(vbeta.fa, \hlstring{"Subject.ID"})
\end{alltt}
\begin{flushleft}\ttfamily\noindent\textcolor{warningcolor}{\#\# Warning: namedlist should not be empty}\end{flushleft}\begin{flushleft}\ttfamily\noindent\textcolor{warningcolor}{\#\# Warning: namedlist should not be empty}\end{flushleft}\begin{alltt}
\hlfunctioncall{show}(sp1)
\end{alltt}
\begin{verbatim}
## SCASet of size  2 
## Samples  Sub01, Sub02 
\end{verbatim}
\begin{alltt}
sp2 <- \hlfunctioncall{split}(vbeta.fa, \hlfunctioncall{factor}(\hlfunctioncall{rbinom}(\hlfunctioncall{nrow}(vbeta.fa), 1, prob = 0.2)))
\end{alltt}
\begin{flushleft}\ttfamily\noindent\textcolor{warningcolor}{\#\# Warning: namedlist should not be empty}\end{flushleft}\begin{flushleft}\ttfamily\noindent\textcolor{warningcolor}{\#\# Warning: namedlist should not be empty}\end{flushleft}\begin{alltt}
\hlfunctioncall{show}(sp2)
\end{alltt}
\begin{verbatim}
## SCASet of size  2 
## Samples  0, 1 
\end{verbatim}
\end{kframe}
\end{knitrout}

The splitting variable can either be a character vector naming column(s) of the \sca, or may be a \texttt{factor} or \texttt{list} of \texttt{factor}s.

It's possible to combine \sca.

\end{document}
